elif mode == "scd2":
    from google.cloud import bigquery

    bq_client = bigquery.Client(project=project_id)

    merge_keys = job["write"]["merge_keys"]
    scd2_cfg = job["write"]["scd2"]

    row_hash_col   = scd2_cfg.get("row_hash_col", "row_hash")
    valid_from_col = scd2_cfg.get("valid_from_col", "valid_from")
    valid_to_col   = scd2_cfg.get("valid_to_col", "valid_to")
    is_current_col = scd2_cfg.get("is_current_col", "is_current")

    open_end_date  = scd2_cfg.get("open_end_date", "9999-12-31")

    # BigQuery expects project.dataset.table
    src_sql_tbl = src_tbl.replace(":", ".")
    tgt_sql_tbl = tgt_tbl.replace(":", ".")

    # JOIN condition on keys
    on_clause = " AND ".join([f"T.{k} = S.{k}" for k in merge_keys])

    # Active record condition (Y/N)
    active_cond = f"IFNULL(T.{is_current_col}, 'N') = 'Y'"

    # --------- Choose columns to hash ----------
    exclude_cols = set(merge_keys + [
        row_hash_col, valid_from_col, valid_to_col, is_current_col,
        "sys_created_on", "sys_created_by", "sys_updated_on", "sys_updated_by"
    ])

    df_cols = list(df.columns)
    hash_cols = [c for c in df_cols if c not in exclude_cols]

    if not hash_cols:
        raise ValueError(
            f"SCD2 cannot compute {row_hash_col} because no hash columns remain. "
            f"df.columns={df_cols}, exclude_cols={sorted(list(exclude_cols))}"
        )

    # --------- Safer hash expr (no STRUCT/JSON) ----------
    # TO_HEX(SHA256(CONCAT(IFNULL(CAST(S.`c1` AS STRING),''), '|', IFNULL(CAST(S.`c2` AS STRING),''), ... )))
    concat_parts = []
    for i, c in enumerate(hash_cols):
        if i > 0:
            concat_parts.append("'|'")
        concat_parts.append(f"IFNULL(CAST(S.`{c}` AS STRING), '')")

    row_hash_expr = f"TO_HEX(SHA256(CONCAT({', '.join(concat_parts)})))"

    # Source subquery: adds row_hash column so S.row_hash always exists
    src_using_sql = f"(SELECT S.*, {row_hash_expr} AS {row_hash_col} FROM `{src_sql_tbl}` S)"

    # Changed condition
    changed_cond = f"IFNULL(T.{row_hash_col}, '') != IFNULL(S.{row_hash_col}, '')"

    # ----------------------------
    # 1) Expire old active row if changed
    # ----------------------------
    expire_sql = f"""
    MERGE `{tgt_sql_tbl}` T
    USING {src_using_sql} S
    ON {on_clause}
    WHEN MATCHED
      AND {active_cond}
      AND ({changed_cond})
    THEN UPDATE SET
      T.{is_current_col} = 'N',
      T.{valid_to_col} = CAST(CURRENT_TIMESTAMP() AS STRING)
    """
    print(expire_sql)
    bq_client.query(expire_sql).result()

    # ----------------------------
    # 2) Insert new row for new keys OR changed keys
    # ----------------------------
    insert_sql = f"""
    INSERT INTO `{tgt_sql_tbl}`
    SELECT
      S.*,
      CAST(CURRENT_TIMESTAMP() AS STRING) AS {valid_from_col},
      CAST(TIMESTAMP('{open_end_date}') AS STRING) AS {valid_to_col},
      'Y' AS {is_current_col}
    FROM {src_using_sql} S
    LEFT JOIN `{tgt_sql_tbl}` T
      ON {on_clause}
      AND {active_cond}
    WHERE
      T.{merge_keys[0]} IS NULL
      OR ({changed_cond})
    """
    print(insert_sql)
    bq_client.query(insert_sql).result()
